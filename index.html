<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <!-- <script src="https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js"></script> -->
  <script src="https://api.map.baidu.com/api?v=3.0&ak=3GG2gig09zYfcWt7iPiYM3s2EnrI9mAW"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #mapcontainer {
      width: 100%;
      height: 100vh
    }

    #coords {
      position: fixed;
      z-index: 2;
    }
  </style>
</head>

<body>
  <div id="coords">
    <span id="span_lo"></span>,<span id="span_la"></span>
  </div>
  <div id="mapcontainer"></div>
  <script>
    const callbackName = "renderReverseBaidu";

    function getBaiduPoint(position) {
      return new Promise((resolve, reject) => {
        const gpsPoint = new BMap.Point(position.coords.longitude, position.coords.latitude);
        const convertor = new BMap.Convertor();
        convertor.translate([gpsPoint], 1, 5, function (res) {
          alert('translated')
          resolve(res)
        })
      })
    }

    function getCurrentPositionInbaidu(position) {
      return new Promise((resolve, reject) => {
        window[callbackName] = (res) => {
          resolve(res)
        }
        getBaiduPoint(position).then(res => {
          let JSONP = document.createElement("script")
          JSONP.type = "text/javascript"
          JSONP.src =
            `https://api.map.baidu.com/geocoder/v2/?callback=${callbackName}&location=${res.points[0].lat},${res.points[0].lng}&output=json&pois=1&ak=3GG2gig09zYfcWt7iPiYM3s2EnrI9mAW`
          document.getElementsByTagName("head")[0].appendChild(JSONP);
          setTimeout(() => {
            document.getElementsByTagName("head")[0].removeChild(JSONP)
          }, 500)
        })
      })
    }

    function getCurrentPosition() {
      const pos = "geolocation" in navigator;
      const options = {
        enableHighAccuracy: true,
        maximumAge: 30000,
        timeout: 30000
      }
      if (pos) {
        return new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(showPosition, showError, options);

          function showPosition(position) {
            resolve(position)
          }

          function showError(error) {
            switch (error.code) {
              case error.PERMISSION_DENIED:
                reject("定位失败,用户拒绝请求地理定位");
                break;
              case error.POSITION_UNAVAILABLE:
                reject("定位失败,位置信息不可用");
                break;
              case error.TIMEOUT:
                reject("定位失败,请求获取用户位置超时");
                break;
              case error.UNKNOWN_ERROR:
                reject("定位失败,定位系统失效");
                break;
              default:
                reject("定位失败");
            }
          }
        })
      } else {
        return Promise.reject("不支持地理定位");
      }
    };

    function draw(point) {
      const map = new window.BMap.Map("mapcontainer");
      map.centerAndZoom(
        new window.BMap.Point(point.lng, point.lat),
        20
      );
      const mappoint = new window.BMap.Point(
        point.lng, point.lat
      );
      const maker = new window.BMap.Marker(mappoint);
      map.addOverlay(maker);
    };
    let span_la = document.getElementById("span_la");
    let span_lo = document.getElementById("span_lo");
    var geolocation = new BMap.Geolocation();
    geolocation.enableSDKLocation();
    geolocation.getCurrentPosition(
      function (r) {
        if (this.getStatus() == BMAP_STATUS_SUCCESS) {
          getCurrentPositionInbaidu({
            coords: {
              latitude: r.latitude,
              longitude: r.longitude
            }
          }).then(res => {
            span_la.innerText = res.result.location.lat;
            span_lo.innerText = res.result.location.lng;
            alert(3);
            draw({
              lat: res.result.location.lat,
              lng: res.result.location.lng
            });
          });
        } else {
          alert("failed " + this.getStatus());
        }
      }, {
        enableHighAccuracy: true
      }
    );
  </script>
</body>

</html>